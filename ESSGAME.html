<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESS MANAGER -Story Edition-</title>
    <style>
       * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

#game-container {
    max-width: 900px;
    margin: 20px auto;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 24px;
    box-shadow: 
        0 30px 90px rgba(0,0,0,0.6),
        0 0 0 1px rgba(255, 255, 255,0.1) inset,
        0 0 40px rgba(102, 126, 234, 0.3);
    min-height: 92vh;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    border: 3px solid rgba(102, 126, 234, 0.2);
    animation: containerFloat 6s ease-in-out infinite;
}

@keyframes containerFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

header {
    background: linear-gradient(135deg, #667eea 0%, #3faf69 50%, #92fcec 100%);
    color: white;
    padding: 24px;
    border-radius: 24px 24px 0 0;
    text-align: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
}

header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 70%
    );
    animation: headerShine 3s ease-in-out infinite;
}

@keyframes headerShine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

header h2 {
    position: relative;
    z-index: 1;
    font-size: 1.8em;
    text-shadow: 
        0 2px 10px rgba(0, 0, 0,0.3),
        0 0 20px rgba(255, 255, 255,0.5);
    letter-spacing: 2px;
}

#status-bar {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    padding: 20px;
    background: linear-gradient(180deg, #e8eaf6 0%, #f5f5f5 100%);
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
}

.stat-box {
    background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    box-shadow: 
        0 4px 12px rgba(0,0,0,0.08),
        0 0 0 1px rgba(102, 126, 234, 0.1) inset;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    transition: left 0.5s;
}

.stat-box:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 
        0 8px 20px rgba(0, 0, 0,0.12),
        0 0 0 2px rgba(102, 126, 234, 0.3) inset;
}

.stat-box:hover::before {
    left: 100%;
}

.stat-label { 
    font-size: 0.75em; 
    color: #666; 
    font-weight: bold; 
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}

.stat-value { 
    font-size: 1.4em; 
    font-weight: bold; 
    background: linear-gradient(135deg, #667eea 0%, #4a8da4 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#main-display {
    flex-grow: 1;
    padding: 24px;
    overflow-y: auto;
    background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%);
}

.story-box {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
    border: 3px solid #47a775;
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 24px;
    position: relative;
    box-shadow: 
        0 8px 24px rgba(77, 162, 162, 0.2),
        0 0 0 1px rgba(255, 255, 255,0.5) inset;
    animation: storyPulse 2s ease-in-out infinite;
}

@keyframes storyPulse {
    0%, 100% { box-shadow: 0 8px 24px rgba(62, 176, 85, 0.2), 0 0 0 1px rgba(255, 255, 255,0.5) inset; }
    50% { box-shadow: 0 8px 32px rgba(74, 164, 88, 0.35), 0 0 20px rgba(64, 174, 91, 0.2) inset; }
}

.story-box::before {
    position: absolute;
    top: -15px;
    left: 20px;
    font-size: 2em;
    background: white;
    padding: 0 8px;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0,0.1);
}

.char-name { 
    font-weight: bold; 
    color: #557199; 
    margin-bottom: 8px;
    font-size: 1.1em;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

#story-text {
    font-size: 1.05em;
    line-height: 1.8;
    color: #2c3e50;
}

.member-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.member-card {
    border: 3px solid #e0e0e0;
    border-radius: 16px;
    padding: 16px;
    background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0,0.08);
}

.member-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #34ba63 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.member-card:hover {
    border-color: #54709a;
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
        0 12px 28px rgba(67, 171, 103, 0.3),
        0 0 20px rgba(79, 159, 97, 0.1);
}

.member-card:hover::before {
    transform: scaleX(1);
}

.member-card.selected {
    border: 3px solid #3791b7;
    background: linear-gradient(145deg, #e6f1f4 0%, #bad1eb 100%);
    box-shadow: 
        0 8px 24px rgba(69, 169, 162, 0.4),
        0 0 30px rgba(56, 182, 163, 0.2) inset;
    animation: selectedPulse 1.5s ease-in-out infinite;
}

@keyframes selectedPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.member-card.graduating {
    border: 3px solid #ff9800;
    background: linear-gradient(145deg, #fff3e0 0%, #ffe0b2 100%);
    box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
}

.member-card.graduating::after {
    content: 'ğŸ“';
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 1.5em;
    animation: graduateFloat 2s ease-in-out infinite;
}

@keyframes graduateFloat {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-5px) rotate(10deg); }
}

.member-card.burnout {
    border: 3px solid #f44336;
    background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
    box-shadow: 0 4px 16px rgba(244, 67, 54, 0.3);
    animation: burnoutShake 0.5s ease-in-out infinite;
}

@keyframes burnoutShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

.progress-bar { 
    height: 10px; 
    background: linear-gradient(90deg, #e0e0e0 0%, #f5f5f5 100%); 
    border-radius: 10px; 
    margin: 8px 0; 
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) inset;
    position: relative;
}

.progress-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255,0.3), transparent);
    animation: progressShine 2s ease-in-out infinite;
}

@keyframes progressShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-fill { 
    height: 100%; 
    background: linear-gradient(90deg, #667eea 0%, #49a56b 100%); 
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    position: relative;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 20px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255,0.4));
    border-radius: 0 10px 10px 0;
}

.recruit-card {
    border: 3px solid #90caf9;
    border-radius: 16px;
    padding: 16px;
    background: linear-gradient(145deg, #ffffff 0%, #e3f2fd 100%);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(2, 136, 209, 0.2);
}

.recruit-card::before {
    content: 'âœ¨';
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 1.5em;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.recruit-card:hover {
    border-color: #0288d1;
    transform: scale(1.05) rotate(1deg);
    box-shadow: 0 12px 32px rgba(2, 136, 209, 0.4);
}

.recruit-card:hover::before {
    opacity: 1;
    animation: sparkle 1s ease-in-out infinite;
}

@keyframes sparkle {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.2) rotate(180deg); }
}

.recruit-card.selected {
    border: 3px solid #0288d1;
    background: linear-gradient(145deg, #e1f5fe 0%, #b3e5fc 100%);
    box-shadow: 
        0 8px 24px rgba(2, 136, 209, 0.5),
        0 0 30px rgba(2, 136, 209, 0.2) inset;
    transform: scale(1.03);
}

#action-panel {
    padding: 24px;
    background: linear-gradient(180deg, #f5f5f5 0%, #e8eaf6 100%);
    border-top: 2px solid rgba(102, 126, 234, 0.2);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0,0.05);
}

button {
    padding: 14px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1em;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255,0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

button:hover::before {
    width: 300px;
    height: 300px;
}

.btn-action { 
    background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); 
    color: #0277bd; 
    border: 2px solid #0288d1;
}

.btn-action:hover:not(:disabled) {
    background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(2, 136, 209, 0.4);
}

.btn-choice { 
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); 
    color: #ad1457; 
    border: 2px solid #c2185b;
}

.btn-choice:hover:not(:disabled) {
    background: linear-gradient(135deg, #f8bbd0 0%, #f48fb1 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(194, 24, 91, 0.4);
}

.btn-next { 
    grid-column: span 2; 
    background: linear-gradient(135deg, #4b71e0 0%, #4a79a4 100%); 
    color: white; 
    margin-top: 10px;
    border: 2px solid rgba(255,255,255,0.3);
    font-size: 1.1em;
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.btn-next:hover:not(:disabled) {
    background: linear-gradient(135deg, #269aae 0%, #b9eaec 100%);
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 32px rgba(62, 176, 85, 0.5);
}

button:disabled { 
    background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); 
    cursor: not-allowed; 
    border: 2px solid #9e9e9e;
    color: #757575;
    opacity: 0.6;
    transform: none !important;
}

.hidden { 
    display: none !important; 
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: modalFadeIn 0.3s ease;
    backdrop-filter: blur(8px);
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}






.modal-content {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    padding: 36px;
    border-radius: 24px;
    max-width: 700px;
    max-height: 85vh;    
    width: 90%;  /* â†è¿½åŠ : ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    margin: 0 auto;  /* â†è¿½åŠ : ä¸­å¤®æƒãˆ */
    overflow-y: auto;
    box-shadow: 
        0 30px 90px rgba(0,0,0,0.5),
        0 0 0 1px rgba(255,255,255,0.5) inset;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 3px solid rgba(102, 126, 234, 0.3);
}

@keyframes modalSlideIn {
    from { 
        transform: translateY(-50px) scale(0.9); 
        opacity: 0;
    }
    to { 
        transform: translateY(0) scale(1); 
        opacity: 1;
    }
}

.modal-content h2 {
    background: linear-gradient(135deg, #667eea 0%, #556499 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2em;
}

.result-box {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
    padding: 28px;
    border-radius: 20px;
    margin: 24px 0;
    text-align: center;
    font-size: 1.6em;
    font-weight: bold;
    color: #333;
    box-shadow: 
        0 8px 24px rgba(255, 215, 0, 0.4),
        0 0 40px rgba(255, 215, 0, 0.3) inset;
    animation: resultShine 2s ease-in-out infinite;
    border: 3px solid #ffb300;
}

@keyframes resultShine {
    0%, 100% { 
        box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4), 0 0 40px rgba(255, 215, 0, 0.3) inset; 
    }
    50% { 
        box-shadow: 0 12px 36px rgba(255, 215, 0, 0.6), 0 0 60px rgba(255, 215, 0, 0.5) inset; 
    }
}

.trait-tag {
    display: inline-block;
    padding: 4px 10px;
    margin: 3px;
    border-radius: 16px;
    font-size: 0.8em;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}

.trait-tag:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0,0.25);
}

.trait-active { background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); color: #1b5e20; border: 2px solid #43a047; }
.trait-passive { background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%); color: #bf360c; border: 2px solid #e64a19; }
.trait-leader { background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); color: #f57f17; border: 2px solid #fbc02d; }
.trait-steady { background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%); color: #0d47a1; border: 2px solid #1976d2; }
.trait-cheerful { background: linear-gradient(135deg, #f8bbd0 0%, #f48fb1 100%); color: #880e4f; border: 2px solid #c2185b; }
.trait-cautious { background: linear-gradient(135deg, #d1c4e9 0%, #b39ddb 100%); color: #311b92; border: 2px solid #512da8; }
.trait-lazy { background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); color: #212121; border: 2px solid #616161; }
.trait-excellent { background: linear-gradient(135deg, #b2dfdb 0%, #80cbc4 100%); color: #004d40; border: 2px solid #00695c; }

.burnout-warning {
    background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
    border: 3px solid #f44336;
    padding: 16px;
    border-radius: 14px;
    margin: 16px 0;
    color: #b71c1c;
    font-weight: bold;
    box-shadow: 
        0 6px 20px rgba(244, 67, 54, 0.3),
        0 0 20px rgba(244, 67, 54, 0.1) inset;
    animation: warningPulse 1.5s ease-in-out infinite;
}

@keyframes warningPulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3), 0 0 20px rgba(244, 67, 54, 0.1) inset; 
    }
    50% { 
        transform: scale(1.02); 
        box-shadow: 0 8px 28px rgba(244, 67, 54, 0.5), 0 0 30px rgba(244, 67, 54, 0.2) inset; 
    }
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #55a24d 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #4ea06a 0%, #a4ccea 100%);
}

/* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
#title-screen {
    background: linear-gradient(135deg, #e1e6fb 0%, #e1f9f3 50%, #f8fefb 100%);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    color: black;
    animation: titleGradient 5s ease infinite;
    background-size: 200% 200%;
}

@keyframes titleGradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

#title-screen h1 {
    font-size: 3.5em;
    text-shadow: 
        0 4px 20px rgba(0, 0, 0,0.4),
        0 0 40px rgba(255,255,255,0.5);
    animation: titleFloat 3s ease-in-out infinite;
    margin-bottom: 20px;
}

@keyframes titleFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-15px); }
}

#title-screen p {
    font-size: 1.3em;
    text-shadow: 0 2px 10px rgba(0, 0, 0,0.3);
    margin: 30px 0;
    animation: titleFade 2s ease-in-out infinite;
}

@keyframes titleFade {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}


/* å®Ÿç¸¾ãƒœã‚¿ãƒ³ */
.achievement-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #333;
    border: 3px solid #ffb300;
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    transition: all 0.3s ease;
    z-index: 10;
}

.achievement-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
}

.achievement-badge {
    background: rgba(255, 255, 255, 0.3);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.85em;
    margin-left: 5px;
}

/* å®Ÿç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ« */
.achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

.achievement-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border: 3px solid #e0e0e0;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.achievement-card.unlocked {
    border-color: #ffd700;
    background: linear-gradient(145deg, #fffbea 0%, #fff9c4 100%);
    box-shadow: 0 8px 24px rgba(255, 215, 0, 0.3);
}

.achievement-card.locked {
    opacity: 0.5;
    filter: grayscale(0.8);
}

.achievement-icon {
    font-size: 3em;
    margin-bottom: 10px;
    display: block;
}

.achievement-card.unlocked .achievement-icon {
    animation: iconPop 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes iconPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.achievement-name {
    font-weight: bold;
    font-size: 1.1em;
    color: #333;
    margin: 10px 0 5px;
}

.achievement-desc {
    font-size: 0.9em;
    color: #666;
    line-height: 1.4;
}

.achievement-date {
    font-size: 0.75em;
    color: #999;
    margin-top: 8px;
    font-style: italic;
}

/* å®Ÿç¸¾è§£é™¤é€šçŸ¥ */
.achievement-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    border: 3px solid #ffb300;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5);
    z-index: 3000;
    animation: notificationSlideIn 0.5s ease, notificationShine 2s ease-in-out infinite;
    min-width: 300px;
}

@keyframes notificationSlideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes notificationShine {
    0%, 100% {
        box-shadow: 0 8px 32px rgba(255, 215, 0, 0.5);
    }
    50% {
        box-shadow: 0 12px 48px rgba(255, 215, 0, 0.8);
    }
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.notification-icon {
    font-size: 2.5em;
    animation: iconRotate 1s ease-in-out infinite;
}

@keyframes iconRotate {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-10deg) scale(1.1); }
    75% { transform: rotate(10deg) scale(1.1); }
}

.notification-text {
    flex: 1;
}

.notification-title {
    font-weight: bold;
    font-size: 1.2em;
    color: #333;
    margin-bottom: 5px;
}

.notification-desc {
    font-size: 0.95em;
    color: #555;
}

/* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
.event-card-modal {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
}

.event-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
    border: 4px solid;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: cardFlip 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

@keyframes cardFlip {
    0% {
        transform: perspective(1000px) rotateY(90deg) scale(0.8);
        opacity: 0;
    }
    100% {
        transform: perspective(1000px) rotateY(0deg) scale(1);
        opacity: 1;
    }
}

.event-card.positive {
    border-color: #4caf50;
    background: linear-gradient(145deg, #e8f5e9 0%, #c8e6c9 100%);
}

.event-card.negative {
    border-color: #f44336;
    background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
}

.event-card.neutral {
    border-color: #2196f3;
    background: linear-gradient(145deg, #e3f2fd 0%, #bbdefb 100%);
}

.event-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 70%
    );
    animation: cardShine 3s ease-in-out infinite;
}

@keyframes cardShine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.event-icon {
    font-size: 4em;
    text-align: center;
    margin-bottom: 20px;
    animation: eventIconBounce 1s ease-in-out infinite;
    position: relative;
    z-index: 1;
}

@keyframes eventIconBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.event-title {
    font-size: 1.8em;
    font-weight: bold;
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    position: relative;
    z-index: 1;
}

.event-description {
    font-size: 1.1em;
    line-height: 1.6;
    color: #555;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    z-index: 1;
}

.event-effects {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    padding: 15px;
    margin: 20px 0;
    position: relative;
    z-index: 1;
}

.event-effect-item {
    padding: 8px 0;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.event-effect-positive {
    color: #2e7d32;
}

.event-effect-negative {
    color: #c62828;
}

/* ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« */
#save-load-panel {
    background: linear-gradient(180deg, #f5f5f5 0%, #e8eaf6 100%);
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
    #save-load-panel {
        grid-template-columns: 1fr;
    }
}

/* å®Ÿç¸¾ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆãƒ‘ãƒãƒ«å†…ã«é…ç½®ã™ã‚‹ãŸã‚ï¼‰ */
.achievement-button {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #333;
    border: 3px solid #ffb300;
    border-radius: 12px;
    padding: 14px 20px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    transition: all 0.3s ease;
    font-size: 1em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.achievement-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
}


.save-slot {
    background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.save-slot:hover {
    border-color: #667eea;
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.save-slot.empty {
    opacity: 0.6;
    font-style: italic;
    color: #999;
}

.save-slot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.save-slot-title {
    font-weight: bold;
    font-size: 1.1em;
    color: #333;
}

.save-slot-date {
    font-size: 0.85em;
    color: #666;
}

.save-slot-info {
    font-size: 0.9em;
    color: #555;
    display: flex;
    gap: 15px;
}

/* ãƒ‘ãƒ«ã‚¹åŠ¹æœï¼ˆæ–°è¦å®Ÿç¸¾è§£é™¤æ™‚ï¼‰ */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}


    </style>
</head>
<body>

<div id="game-container">
    <div id="title-screen" style="padding: 60px; text-align: center;">
        <h1 style="font-size: 3em; color: #529c7c;">ESS MANAGER</h1>
        <p style="margin: 20px 0;">ï½æ”»ç•¥æ–¹æ³•ã¯<a href="exp.html"> ã“ã¡ã‚‰</a>ï½</p>
        <button onclick="initGame()" class="btn-next" style="padding: 20px;">ç‰©èªã‚’å§‹ã‚ã‚‹</button>
    </div>



<div id="game-main" class="hidden">
    <!-- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰/å®Ÿç¸¾ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ« -->
    <div id="save-load-panel">
        <button onclick="saveGame()" class="btn-action" style="flex: 1;">ğŸ’¾ ã‚»ãƒ¼ãƒ–</button>
        <button onclick="loadGame()" class="btn-action" style="flex: 1;">ğŸ“‚ ãƒ­ãƒ¼ãƒ‰</button>
        <button onclick="showAchievementModal()" class="achievement-button">
            ğŸ† å®Ÿç¸¾ <span id="achievement-count" class="achievement-badge">0/12</span>
        </button>
    </div>

<!-- ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã—ã¦è¡¨ç¤ºï¼‰ -->
<div id="event-card-container"></div>

<!-- å®Ÿç¸¾è§£é™¤é€šçŸ¥ç”¨ -->
<div id="achievement-notification" class="achievement-notification hidden">
    <div class="notification-content">
        <div class="notification-icon">ğŸ†</div>
        <div class="notification-text">
            <div class="notification-title">å®Ÿç¸¾è§£é™¤ï¼</div>
            <div class="notification-desc"></div>
        </div>
    </div>
</div>
    
    
    
        <header>
            <h2 id="display-week">ç¬¬ 1 é€±</h2>
        </header>

        <div id="status-bar">
            <div class="stat-box"><div class="stat-label">å¹´åº¦</div><div class="stat-value" id="stat-year">1å¹´ç›®</div></div>
            <div class="stat-box"><div class="stat-label">éƒ¨è²»</div><div class="stat-value" id="stat-budget">Â¥0</div></div>
            <div class="stat-box"><div class="stat-label">éƒ¨å“¡</div><div class="stat-value" id="stat-members">0</div></div>
            <div class="stat-box"><div class="stat-label">è‹±èªåŠ›</div><div class="stat-value" id="stat-eng">0</div></div>
            <div class="stat-box"><div class="stat-label">ä¿¡é ¼</div><div class="stat-value" id="stat-trust">0</div></div>
        </div>

        <div id="main-display">
            <div class="story-box">
                <div id="char-name" class="char-name">æ©˜</div>
                <div id="story-text"></div>
            </div>
            <div id="member-list" class="member-grid"></div>
        </div>

        <div id="action-panel"></div>
    </div>
</div>

<script>
    const state = {
        week: 1,
        maxWeek: 10,
        year: 1,
        budget: 2000,
        trust: 40,
        members: [
            { name: "å±±ç”°", eng: 29, stress: 0, trait: "ç©æ¥µçš„", year: 3, growthRate: 1.2, burnout: false },
            { name: "æ©˜", eng: 55, stress: 0, trait: "ãƒªãƒ¼ãƒ€ãƒ¼", year: 5, growthRate: 0.5, burnout: false }
        ],
        hasActed: false,
        contestWeek: 6,
        contestDone: false
    };

    // ç‰¹æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    const traitData = {
        "ç©æ¥µçš„": { growthRate: 0.75, stressRate: 1.0, cssClass: "trait-active", desc: "æˆé•·â†‘" },
        "æ¶ˆæ¥µçš„": { growthRate: 0.4, stressRate: 0.8, cssClass: "trait-passive", desc: "æˆé•·â†“" },
        "ãƒªãƒ¼ãƒ€ãƒ¼": { growthRate: 0.55, stressRate: 0.7, cssClass: "trait-leader", desc: "ä¿¡é ¼â†‘" },
        "çœŸé¢ç›®": { growthRate: 0.5, stressRate: 1.2, cssClass: "trait-steady", desc: "æ¨™æº–" },
        "å…ƒæ°—": { growthRate: 0.6, stressRate: 0.6, cssClass: "trait-cheerful", desc: "ç–²ã‚Œã«ãã„" },
        "æ…é‡": { growthRate: 0.5, stressRate: 0.9, cssClass: "trait-cautious", desc: "å®‰å®š" },
        "ã®ã‚“ã³ã‚Š": { growthRate: 0.43, stressRate: 0.5, cssClass: "trait-lazy", desc: "æˆé•·é…ã„" },
        "å„ªç§€": { growthRate: 0.8, stressRate: 1.3, cssClass: "trait-excellent", desc: "æˆé•·â—ç–²ã‚Œã‚„ã™ã„" }
    };

    const recruitPool = [
        { name: "å·ç”°", eng: 14, trait: "ç©æ¥µçš„", year: 3 },
        { name: "è¥¿å·", eng: 22, trait: "ç©æ¥µçš„", year: 1 },
        { name: "æœå€‰", eng: 16, trait: "å…ƒæ°—", year: 1 },
        { name: "å‰ç”°", eng: 27, trait: "ãƒªãƒ¼ãƒ€ãƒ¼", year: 2 },
        { name: "å¤§å‰", eng: 18, trait: "æ¶ˆæ¥µçš„", year: 2 },
        { name: "æ©‹æœ¬", eng: 26, trait: "æ¶ˆæ¥µçš„", year: 2 },
        { name: "ä½è—¤", eng: 22, trait: "çœŸé¢ç›®", year: 2 },
        { name: "ç¥è°·", eng: 32, trait: "å„ªç§€", year: 2 },
        { name: "æ—", eng: 22, trait: "å…ƒæ°—", year: 1 },
        { name: "è—¤åŸ", eng: 26, trait: "ãƒªãƒ¼ãƒ€ãƒ¼", year: 1 },
        { name: "æ—©å·", eng: 38, trait: "ã®ã‚“ã³ã‚Š", year: 3 },
        { name: "ä¸‹æµ¦", eng: 24, trait: "çœŸé¢ç›®", year: 1 },
        { name: "å²¡å´", eng: 29, trait: "ç©æ¥µçš„", year: 1 },
        { name: "åŸç”°", eng: 24, trait: "å…ƒæ°—", year: 1 },
        { name: "ä¸‰åŸ", eng: 25, trait: "çœŸé¢ç›®", year: 1 },
        { name: "éˆ´æœ¨", eng: 20, trait: "æ¶ˆæ¥µçš„", year: 1 },
        { name: "å‚å£", eng: 22, trait: "çœŸé¢ç›®", year: 1 }
    ];

    const scenarios = {
        1: {
            char: "å…ƒéƒ¨é•·",
            text: "éƒ¨å“¡ãŒç§ã¨ã‚ãªãŸã ã‘ã˜ã‚ƒå»ƒéƒ¨ã«ãªã£ã¦ã—ã¾ã†ã€‚ã¾ãšã¯ä»²é–“ã‚’å¢—ã‚„ãã†ï¼ç§ã‚‚ã¾ã åœ¨å­¦ä¸­ã ã‹ã‚‰æ‰‹ä¼ã†ã‚ˆã€‚",
            action: "scout_required"
        },
        2: {
            char: "å…ƒéƒ¨é•·",
            text: "æ–°å…¥éƒ¨å“¡ã€ç¢ºä¿ã§ã™ï¼â€¦ã§ã‚‚ã€ã“ã®å­ãŸã¡ã€Helloã€ã®ç™ºéŸ³ãŒã€Œãƒãƒ­ãƒ¼ï¼ˆæ£’èª­ã¿ï¼‰ã€ã§ã™ã‚ˆã€‚ä»Šé€±ã¯åœ°ç„ã®ç‰¹è¨“ã€ã„ã„ã§ã™ã‚ˆã­ï¼Ÿ",
            action: "free"
        },
        3: {
            char: "å¹³é‡å…ˆç”Ÿ",
            text: "ãµã‚“ã€‚æ–°äººãŒå…¥ã£ãŸãã†ã ãªã€‚ã ãŒç”˜ã‚„ã‹ã™ã¤ã‚‚ã‚Šã¯ãªã„ã€‚ã—ã£ã‹ã‚Šé›ãˆã‚ã€‚",
            action: "free"
        },
        4: {
            char: "å…ƒéƒ¨é•·",
            text: "ã‚ˆã†ã‚„ãã€éƒ¨æ´»ã—ã¦ã‚‹ã£ã½ã„ã€é›°å›²æ°—ã«ãªã£ã¦ãã¾ã—ãŸã­ï¼ã“ã®èª¿å­ã§ã€å­¦æ ¡ä¸­ã®ç”Ÿå¾’ã«ç§ãŸã¡ã®æµæš¢ãªRã¨Lã®ä½¿ã„åˆ†ã‘ã‚’è¦‹ã›ã¤ã‘ã¡ã‚ƒã„ã¾ã—ã‚‡ã†ï¼",
            action: "free"
        },
        5: {
            char: "å¹³é‡å…ˆç”Ÿ",
            text: "æ¥é€±ã€åœ°åŒºã‚³ãƒ³ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã‚“ã ã€‚2åã‚’é¸æŠœã—ã¦å‡ºå ´ã•ã›ã‚ˆã†ã€‚å„ªå‹ã™ã‚Œã°å¤§ããæˆé•·ã§ãã‚‹ï¼",
            action: "free"
        },
        6: {
            char: "æ²ç¤ºæ¿",
            text: "ã€æœ¬æ—¥é–‹å‚¬ã€‘åœ°åŒºè‹±èªã‚¹ãƒ”ãƒ¼ãƒã‚³ãƒ³ãƒ†ã‚¹ãƒˆã€‚å‡ºå ´è€…2åã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
            action: "contest"
        },
        7: {
            char: "å…ƒéƒ¨é•·",
            text: "ã‚³ãƒ³ãƒ†ã‚¹ãƒˆãŒçµ‚ã‚ã‚Šã¾ã—ãŸã­ï¼å¾ŒåŠæˆ¦ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
            action: "free"
        },
        8: {
            char: "å¹³é‡å…ˆç”Ÿ",
            text: "ãŠå‰ãŸã¡ãŒæ›¸ã„ãŸã‚¹ãƒ”ãƒ¼ãƒåŸç¨¿ã®æ·»å‰Šã§ã€ç§ã®èµ¤ã„ãƒšãƒ³ãŒ3æœ¬ã‚‚ã‚¤ãƒ³ã‚¯åˆ‡ã‚Œã«ãªã£ãŸè²¬ä»»ã¯å–ã£ã¦ã‚‚ã‚‰ã†ãã€‚æœ€å¾Œã¾ã§ç¶šã‘ã‚ã€‚",
            action: "free"
        },
        9: {
            char: "å…ƒéƒ¨é•·",
            text: "ã‚‚ã†ã™ãæœ€çµ‚é€±ã ã­ã€‚æ‚”ã„ã®ãªã„ã‚ˆã†ã€å…¨åŠ›ã§æ´»å‹•ã—ã‚ˆã†ï¼ã‚ã€éƒ¨è²»ãŒä½™ã£ãŸã‚‰ç§ã«é‚„å…ƒã—ã¦ã‚‚ã„ã„ã‚“ã ã‚ˆï¼Ÿ",
            action: "free"
        },
        10: {
            char: "å…ƒéƒ¨é•·",
            text: "æœ€çµ‚é€±ã§ã™ï¼ç§ãŸã¡ã®ã€ESS MANAGERã€ã€æœ€é«˜ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿ãˆã¾ã—ã‚‡ã†ï¼",
            action: "free"
        }
    };

    function initGame() {
        // ç‰¹æ€§ã«æˆé•·ç‡ã‚’è¨­å®š
        state.members.forEach(m => {
            const trait = traitData[m.trait];
            if (trait) {
                m.growthRate = trait.growthRate;
            }
            if (m.burnout === undefined) {
                m.burnout = false;
            }
        });
        
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-main').classList.remove('hidden');
        loadWeek();
    }

    function loadWeek() {
        state.hasActed = false;
        
        // ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
        checkBurnout();
        
        const scenario = scenarios[state.week] || {
            char: "Nina",
            text: "ä»Šé€±ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
            action: "free"
        };

        document.getElementById('char-name').textContent = scenario.char;
        document.getElementById('story-text').textContent = scenario.text;
        
        if (scenario.action === "scout_required") {
            showScoutModal();
        } else if (scenario.action === "contest") {
            showContestModal();
        } else {
            renderActionButtons();
        }
        
        updateUI();
    }

    function checkBurnout() {
        let burnoutMessages = [];
        state.members.forEach(m => {
            if (m.stress >= 100 && !m.burnout) {
                m.burnout = true;
                m.eng = Math.floor(m.eng * 0.7); // è‹±èªåŠ›30%æ¸›å°‘
                state.trust -= 15; // ä¿¡é ¼åº¦ä½ä¸‹
                burnoutMessages.push(`${m.name}ãŒç‡ƒãˆå°½ãç—‡å€™ç¾¤ã«ãªã£ã¦ã—ã¾ã£ãŸï¼ï¼ˆè‹±èªåŠ›-30%ã€ä¿¡é ¼åº¦-15ï¼‰`);
            }
        });
        
        if (burnoutMessages.length > 0) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="margin-bottom: 20px; color: #f44336;">âš ï¸ è­¦å‘Š</h2>
                    <div class="burnout-warning">
                        ${burnoutMessages.join('<br>')}
                    </div>
                    <p style="margin: 15px 0;">ç‡ƒãˆå°½ãç—‡å€™ç¾¤ã®éƒ¨å“¡ã¯æˆé•·ã§ãã¾ã›ã‚“ã€‚è¦ªç¦ä¼šãªã©ã§ã‚±ã‚¢ã—ã¾ã—ã‚‡ã†ã€‚</p>
                    <button onclick="this.closest('.modal').remove()" class="btn-next">ç¢ºèª</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
    }

    function showScoutModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <h2 style="margin-bottom: 20px; color: #587196;">æ–°å…¥ç”Ÿã‚¹ã‚«ã‚¦ãƒˆ</h2>
                <p style="margin-bottom: 15px;">æœ€å¤§3åã¾ã§é¸ã‚“ã§ã‚¹ã‚«ã‚¦ãƒˆã§ãã¾ã™ï¼ˆè²»ç”¨ï¼šÂ¥500ï¼‰</p>
                <div id="recruit-list" class="member-grid"></div>
                <button id="confirm-scout" class="btn-next" style="margin-top: 20px;">æ±ºå®š</button>
            </div>
        `;
        document.body.appendChild(modal);

        const selectedRecruits = [];
        const recruitList = document.getElementById('recruit-list');
        
        // æ—¢å­˜ã®éƒ¨å“¡åãƒªã‚¹ãƒˆã‚’å–å¾—
        const existingNames = state.members.map(m => m.name);
        
        // æ—¢å­˜éƒ¨å“¡ã‚’é™¤å¤–ã—ãŸå€™è£œè€…ãƒªã‚¹ãƒˆ
        const availableCandidates = recruitPool.filter(r => !existingNames.includes(r.name));
        const candidates = [...availableCandidates].sort(() => Math.random() - 0.5).slice(0, 6);
        
        candidates.forEach(r => {
            const trait = traitData[r.trait];
            const card = document.createElement('div');
            card.className = 'recruit-card';
            card.innerHTML = `
                <h4>${r.name}ï¼ˆ${r.year}å¹´ï¼‰</h4>
                <div class="stat-label">è‹±èªåŠ›: ${r.eng}</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${r.eng/2}%"></div></div>
                <div class="stat-label">ç‰¹æ€§: <span class="trait-tag ${trait.cssClass}">${r.trait}</span></div>
                <div class="stat-label" style="font-size: 0.7em; color: #888;">${trait.desc}</div>
            `;
            card.onclick = () => {
                if (card.classList.contains('selected')) {
                    card.classList.remove('selected');
                    const idx = selectedRecruits.indexOf(r);
                    selectedRecruits.splice(idx, 1);
                } else if (selectedRecruits.length < 3) {
                    card.classList.add('selected');
                    selectedRecruits.push(r);
                }
            };
            recruitList.appendChild(card);
        });

        document.getElementById('confirm-scout').onclick = () => {
            if (selectedRecruits.length > 0) {
                state.budget -= 500;
                selectedRecruits.forEach(r => {
                    const trait = traitData[r.trait];
                    state.members.push({ 
                        ...r, 
                        stress: 0,
                        growthRate: trait.growthRate,
                        burnout: false
                    });
                });
                document.getElementById('story-text').textContent = `${selectedRecruits.map(r => r.name).join('ã€')}ãŒå…¥éƒ¨ã—ã¾ã—ãŸï¼`;
            } else {
                document.getElementById('story-text').textContent = "ä»Šå›ã¯ã‚¹ã‚«ã‚¦ãƒˆã‚’è¦‹é€ã‚Šã¾ã—ãŸã€‚";
            }
            document.body.removeChild(modal);
            state.hasActed = true;
            updateUI();
            renderActionButtons();
        };
    }

function showContestModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: #5f8f8a;">ã‚³ãƒ³ãƒ†ã‚¹ãƒˆå‡ºå ´è€…é¸æŠœ</h2>
            <p style="margin-bottom: 15px;">å‚åŠ è²»:Â¥1000</p>
            <p style="margin-bottom: 15px;">2åã‚’é¸ã‚“ã§ãã ã•ã„(ç‡ƒãˆå°½ãç—‡å€™ç¾¤ã®éƒ¨å“¡ã¯é¸ã¹ã‚‹ã¾ã›ã‚“)</p>
            <div id="contest-list" class="member-grid"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button id="confirm-contest" class="btn-next" disabled>æ±ºå®š</button>
                <button id="skip-contest" class="btn-choice">å‚åŠ ã—ãªã„</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    const selectedMembers = [];
    const contestList = document.getElementById('contest-list');

    // ã€Œå‚åŠ ã—ãªã„ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆinnerHTMLã®å¤–ã«è¨˜è¿°ï¼‰
    document.getElementById('skip-contest').onclick = () => {
        document.body.removeChild(modal);
        document.getElementById('story-text').textContent = "ä»Šå›ã¯ã‚³ãƒ³ãƒ†ã‚¹ãƒˆå‚åŠ ã‚’è¦‹é€ã‚Šã¾ã—ãŸã€‚";
        state.hasActed = true;
        state.contestDone = true;
        updateUI();
        renderActionButtons();
    };

    // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
    state.members.forEach(m => {
        const trait = traitData[m.trait];
        const card = document.createElement('div');
        card.className = `member-card ${m.burnout ? 'burnout' : ''}`;
        card.innerHTML = `
            <h4>${m.name}ï¼ˆ${m.year}å¹´ï¼‰${m.burnout ? ' ğŸ”¥' : ''}</h4>
            <div class="stat-label">è‹±èªåŠ›: ${m.eng}</div>
            <div class="progress-bar"><div class="progress-fill" style="width:${m.eng / 2}%"></div></div>
            <div class="stat-label">ç‰¹æ€§: <span class="trait-tag ${trait.cssClass}">${m.trait}</span></div>
            ${m.burnout ? '<div class="stat-label" style="color: #f44336;">ç‡ƒãˆå°½ãç—‡å€™ç¾¤</div>' : ''}
        `;

        if (!m.burnout) {
            card.onclick = () => {
                if (card.classList.contains('selected')) {
                    card.classList.remove('selected');
                    const idx = selectedMembers.indexOf(m);
                    if (idx > -1) selectedMembers.splice(idx, 1);
                } else if (selectedMembers.length < 2) {
                    card.classList.add('selected');
                    selectedMembers.push(m);
                }
                document.getElementById('confirm-contest').disabled = (selectedMembers.length !== 2);
            };
        } else {
            card.style.cursor = 'not-allowed';
            card.style.opacity = '0.6';
        }
        contestList.appendChild(card);
    });

    // ã€Œæ±ºå®šã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
    document.getElementById('confirm-contest').onclick = () => {
        if (state.budget < 1000) {
            alert('å‚åŠ è²»ãŒä¸è¶³ã—ã¦ã„ã¾ã™!');
            return;
        }

        state.budget -= 1000;
        const avgEng = (selectedMembers[0].eng + selectedMembers[1].eng) / 2;

        let winChance = Math.min(90, avgEng * 0.6);
        let secondChance = Math.min(95, avgEng * 0.75);

        const roll = Math.random() * 100;
        let result = "";
        let prize = 0;
        let engBonus = 0;
        let trustBonus = 0;

        if (roll < winChance) {
            result = "ğŸ† å„ªå‹";
            prize = 5000;
            engBonus = 8;
            trustBonus = 30;
        } else if (roll < secondChance) {
            result = "ğŸ¥ˆ æº–å„ªå‹";
            prize = 2000;
            engBonus = 5;
            trustBonus = 15;
        } else {
            result = "ğŸ“ å‚åŠ è³";
            prize = 500;
            engBonus = 3;
            trustBonus = 5;
        }

        // æˆé•·å‡¦ç†
        selectedMembers.forEach(m => {
            const growth = Math.floor(engBonus * m.growthRate);
            m.eng += growth;
            if (m.eng > 200) m.eng = 200;
        });

        state.budget += prize;
        state.trust += trustBonus;
        state.contestDone = true;
        state.hasActed = true;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å‰Šé™¤
        document.body.removeChild(modal);

        // çµæœè¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        const resultModal = document.createElement('div');
        resultModal.className = 'modal';
        resultModal.innerHTML = `
            <div class="modal-content">
                <h2 style="margin-bottom: 20px; color: #607e8e;">ã‚³ãƒ³ãƒ†ã‚¹ãƒˆçµæœ</h2>
                <div class="result-box" style="font-size: 1.5rem; text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">${result}</div>
                <p style="margin: 10px 0;">å‡ºå ´è€…: ${selectedMembers.map(m => m.name).join('ã¨')}</p>
                <p style="margin: 10px 0;">å‚åŠ è²»: -Â¥1000</p> 
                <p style="margin: 10px 0;">ç²å¾—è³é‡‘: Â¥${prize}</p>
                <p style="margin: 10px 0;">èƒ½åŠ›ä¸Šæ˜‡: +${engBonus} (æˆé•·ç‡åæ˜ æ¸ˆã¿)</p>
                <p style="margin: 10px 0;">ä¿¡é ¼åº¦ä¸Šæ˜‡: +${trustBonus}</p>
                <button id="close-result" class="btn-next" style="margin-top: 20px;">é–‰ã˜ã‚‹</button>
            </div>
        `;
        document.body.appendChild(resultModal);

        document.getElementById('close-result').onclick = () => {
            document.body.removeChild(resultModal);
            document.getElementById('story-text').textContent = `ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã§${result}ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`;
            updateUI();
            renderActionButtons();
        };
    };
}

    function renderActionButtons() {
        const panel = document.getElementById('action-panel');
        panel.innerHTML = '';

        const actions = [
            { id: 'train', name: "ğŸ“– é€šå¸¸ç‰¹è¨“", cost: 200, color: 'btn-action' },
            { id: 'supertrain', name: "ğŸ”¥ è¶…ç‰¹è¨“", cost: 800, color: 'btn-action' },
            { id: 'work', name: "ğŸ’¼ ç¿»è¨³ãƒã‚¤ãƒˆ", cost: 0, color: 'btn-action' },
            { id: 'hangout', name: "ğŸ¡ è¦ªç¦ä¼š", cost: 300, color: 'btn-action' },
            { id: 'scout', name: "ğŸ” ã‚¹ã‚«ã‚¦ãƒˆ", cost: 500, color: 'btn-action' }
        ];

        actions.forEach(a => {
            const btn = document.createElement('button');
            btn.className = a.color;
            btn.textContent = a.cost > 0 ? `${a.name}(Â¥${a.cost})` : a.name;
            btn.disabled = state.hasActed || (a.cost > 0 && state.budget < a.cost);
            btn.onclick = () => executeAction(a.id);
            panel.appendChild(btn);
        });

        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn-next';
        nextBtn.textContent = state.hasActed ? "æ¬¡é€±ã¸é€²ã‚€ â­ï¸" : "è¡Œå‹•ã‚’é¸ã‚“ã§ãã ã•ã„";
        nextBtn.disabled = !state.hasActed;
        nextBtn.onclick = nextWeek;
        panel.appendChild(nextBtn);
    }

    function executeAction(type) {
        if (state.hasActed) return;
        
        let msg = "";
        switch(type) {
            case 'train':
                state.budget -= 200;
                state.members.forEach(m => { 
                    if (!m.burnout) {
                        const trait = traitData[m.trait];
                        const growth = Math.floor(5 * m.growthRate);
                        m.eng += growth;
                        if (m.eng > 200) m.eng = 200;
                        m.stress += Math.floor(15 * trait.stressRate);
                    }
                });
                msg = "é€šå¸¸ç‰¹è¨“ã§è‹±èªåŠ›ãŒä¸ŠãŒã£ãŸï¼";
                break;
                
            case 'supertrain':
                state.budget -= 800;
                state.members.forEach(m => { 
                    if (!m.burnout) {
                        const trait = traitData[m.trait];
                        const growth = Math.floor(15 * m.growthRate);
                        m.eng += growth;
                        if (m.eng > 200) m.eng = 200;
                        m.stress += Math.floor(35 * trait.stressRate);
                    }
                });
                msg = "è¶…ç‰¹è¨“ã§ã‹ãªã‚Šè‹±èªåŠ›ãŒä¸ŠãŒã£ãŸï¼ï¼";
                break;
                
            case 'scout':
                showScoutModal();
                return;
                
            case 'work':
                const reward = 800;
                state.budget += reward;
                state.members.forEach(m => {
                    const trait = traitData[m.trait];
                    m.stress += Math.floor(20 * trait.stressRate);
                });
                msg = `ãƒã‚¤ãƒˆã§Â¥${reward}ç¨¼ãã¾ã—ãŸï¼`;
                break;
                
            case 'hangout':
                state.budget -= 300;
                state.members.forEach(m => m.stress = Math.max(0, m.stress - 30));
                state.trust += 10;
                msg = "è¦ªç¦ä¼šã§ã¿ã‚“ãªã®çµ†ãŒæ·±ã¾ã£ãŸï¼";
                break;
        }

        state.hasActed = true;
        document.getElementById('story-text').textContent = msg;
        updateUI();
        renderActionButtons();
    }

    function nextWeek() {
        state.week++;
        if (state.week > state.maxWeek) {
            endYear();
        } else {
            loadWeek();
        }
    }

    function endYear() {
        const graduating = state.members.filter(m => m.year >= 5);
        const continuing = state.members.filter(m => m.year < 5);
        
        continuing.forEach(m => m.year++);
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        let graduationMsg = "";
        if (graduating.length > 0) {
            graduationMsg = `<p style="color: #ff6f00; font-weight: bold; margin: 15px 0;">
                ğŸ“ ${graduating.map(m => m.name).join('ã€')}ãŒå’æ¥­ã—ã¾ã—ãŸ
            </p>`;
        updateGraduationStats(graduating.length);
        }
        
        modal.innerHTML = `
            <div class="modal-content">
                <h2 style="margin-bottom: 20px; color: #628c8b;">å¹´åº¦çµ‚äº†</h2>
                <div style="background: #f1f2f6; padding: 20px; border-radius: 10px; margin: 15px 0;">
                    <p style="font-size: 1.3em; margin: 10px 0;">ç¬¬${state.year}å¹´åº¦ãŒçµ‚äº†ã—ã¾ã—ãŸ</p>
                    ${graduationMsg}
                    <p style="margin: 10px 0;">ç¶™ç¶šéƒ¨å“¡: ${continuing.length}å</p>
                    <p style="margin: 10px 0;">å¹³å‡è‹±èªåŠ›: ${Math.floor(continuing.reduce((a, b) => a + b.eng, 0) / Math.max(continuing.length, 1))}</p>
                    <p style="margin: 10px 0;">ç¾åœ¨ã®éƒ¨è²»: Â¥${state.budget}</p>
                    <p style="margin: 10px 0;">ä¿¡é ¼åº¦: ${state.trust}</p>
                </div>
                <button id="continue-next-year" class="btn-next" style="margin: 10px 0;">æ¬¡ã®å¹´åº¦ã¸é€²ã‚€</button>
                <button id="end-game-now" class="btn-choice" style="margin: 10px 0;">æ´»å‹•ã‚’çµ‚äº†ã™ã‚‹</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        document.getElementById('continue-next-year').onclick = () => {
            state.year++;
            state.week = 1;
            state.members = continuing;
            state.hasActed = false;
            state.contestDone = false;
            // æ¬¡ã®å¹´åº¦ã«å‘ã‘ãŸãƒœãƒ¼ãƒŠã‚¹ï¼ˆä¿¡é ¼åº¦ã«å¿œã˜ã¦äºˆç®—è¿½åŠ ãªã©ï¼‰
            state.budget += state.trust * 10;
            
            document.body.removeChild(modal);
            initGame(); // æ–°ã—ã„å¹´åº¦ã¨ã—ã¦åˆæœŸåŒ–ï¼ˆã¾ãŸã¯loadWeekï¼‰
        };

        document.getElementById('end-game-now').onclick = () => {
            location.reload(); // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
        };
    }

    function updateUI() {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®æ›´æ–°
        document.getElementById('display-week').textContent = `ç¬¬ ${state.week} é€±`;
        document.getElementById('stat-year').textContent = `${state.year}å¹´ç›®`;
        document.getElementById('stat-budget').textContent = `Â¥${state.budget}`;
        document.getElementById('stat-members').textContent = `${state.members.length}äºº`;
        
        const avgEng = state.members.length > 0 
            ? Math.floor(state.members.reduce((sum, m) => sum + m.eng, 0) / state.members.length) 
            : 0;
        document.getElementById('stat-eng').textContent = avgEng;
        document.getElementById('stat-trust').textContent = state.trust;

        // éƒ¨å“¡ãƒªã‚¹ãƒˆã®è¡¨ç¤ºæ›´æ–°
        const memberList = document.getElementById('member-list');
        memberList.innerHTML = '';
        
        state.members.forEach(m => {
            const trait = traitData[m.trait] || { cssClass: 'trait-steady', desc: 'æ¨™æº–' };
            const card = document.createElement('div');
            card.className = `member-card ${m.year >= 5 ? 'graduating' : ''}`;
            card.innerHTML = `
                <div class="char-name">${m.name} (${m.year}å¹´ç”Ÿ)</div>
                <div class="stat-label">è‹±èªåŠ›: ${m.eng}</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${m.eng}%"></div></div>
                <div class="stat-label">ã‚¹ãƒˆãƒ¬ã‚¹: ${m.stress}</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${m.stress}%; background:#ff4757;"></div></div>
                <div class="stat-label">ç‰¹æ€§: <span class="trait-tag ${trait.cssClass}">${m.trait}</span></div>
            `;
            memberList.appendChild(card);
        });
    }

    // èµ·å‹•æ™‚ã«ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤º
    window.onload = () => {
        document.getElementById('game-main').classList.add('hidden');
    };
    
    
    
    // ============================================
// 1. ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
// ============================================

function saveGame() {
    const saveData = {
        state: state,
        timestamp: new Date().toISOString(),
        version: "1.0"
    };
    
    const saveSlots = JSON.parse(localStorage.getItem('essManagerSaves')) || {};
    const slotKey = `slot_${Date.now()}`;
    saveSlots[slotKey] = saveData;
    
    // æœ€å¤§5å€‹ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    const slots = Object.keys(saveSlots);
    if (slots.length > 5) {
        delete saveSlots[slots[0]];
    }
    
    localStorage.setItem('essManagerSaves', JSON.stringify(saveSlots));
    
    showNotification("ğŸ’¾ ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼", "success");
}

function loadGame() {
    const saveSlots = JSON.parse(localStorage.getItem('essManagerSaves')) || {};
    
    if (Object.keys(saveSlots).length === 0) {
        showNotification("ğŸ“‚ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", "info");
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ãƒ­ãƒ¼ãƒ‰</h2>
            <div id="save-slot-list"></div>
            <button onclick="this.closest('.modal').remove()" class="btn-choice" style="margin-top: 20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    `;
    document.body.appendChild(modal);
    
    const slotList = document.getElementById('save-slot-list');
    
    Object.entries(saveSlots).reverse().forEach(([key, data]) => {
        const date = new Date(data.timestamp);
        const slot = document.createElement('div');
        slot.className = 'save-slot';
        slot.innerHTML = `
            <div class="save-slot-header">
                <div class="save-slot-title">ç¬¬${data.state.year}å¹´åº¦ ç¬¬${data.state.week}é€±</div>
                <div class="save-slot-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
            </div>
            <div class="save-slot-info">
                <span>éƒ¨å“¡: ${data.state.members.length}äºº</span>
                <span>éƒ¨è²»: Â¥${data.state.budget}</span>
                <span>ä¿¡é ¼: ${data.state.trust}</span>
            </div>
        `;
        slot.onclick = () => {
            Object.assign(state, data.state);
            document.body.removeChild(modal);
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('game-main').classList.remove('hidden');
            loadWeek();
            showNotification("ğŸ“‚ ã‚²ãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼", "success");
        };
        slotList.appendChild(slot);
    });
}

// ç°¡æ˜“é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
function showNotification(message, type = "info") {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 4000;
        animation: notificationSlideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'notificationSlideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// ============================================
// å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰
// ============================================

const achievements = {
    perfect_year: {
        id: "perfect_year",
        name: "å®Œç’§ãªå¹´åº¦é‹å–¶",
        desc: "å¹´åº¦çµ‚äº†æ™‚ã«å…¨å“¡ã‚¹ãƒˆãƒ¬ã‚¹50ä»¥ä¸‹",
        icon: "â­",
        unlocked: false,
        unlockedDate: null
    },
    english_master: {
        id: "english_master",
        name: "è‹±èªãƒã‚¹ã‚¿ãƒ¼",
        desc: "å…¨å“¡ã®è‹±èªåŠ›ã‚’50ä»¥ä¸Šã«ã™ã‚‹",
        icon: "ğŸ“š",
        unlocked: false,
        unlockedDate: null
    },
    rich_club: {
        id: "rich_club",
        name: "è³‡é‡‘æ½¤æ²¢",
        desc: "éƒ¨è²»ãŒ10000å††ä»¥ä¸Šã«ãªã‚‹",
        icon: "ğŸ’°",
        unlocked: false,
        unlockedDate: null
    },
    trust_max: {
        id: "trust_max",
        name: "çµ¶å¯¾çš„ä¿¡é ¼",
        desc: "ä¿¡é ¼åº¦ãŒ100ä»¥ä¸Šã«ãªã‚‹",
        icon: "â¤ï¸",
        unlocked: false,
        unlockedDate: null
    },
    big_club: {
        id: "big_club",
        name: "å¤§æ‰€å¸¯",
        desc: "éƒ¨å“¡ãŒ10äººä»¥ä¸Šã«ãªã‚‹",
        icon: "ğŸ‘¥",
        unlocked: false,
        unlockedDate: null
    },
    no_burnout: {
        id: "no_burnout",
        name: "ç‡ƒãˆå°½ãå›é¿",
        desc: "1å¹´é–“èª°ã‚‚ç‡ƒãˆå°½ãç—‡å€™ç¾¤ã«ãªã‚‰ãªã„",
        icon: "ğŸ›¡ï¸",
        unlocked: false,
        unlockedDate: null
    },
    super_growth: {
        id: "super_growth",
        name: "æ€¥æˆé•·",
        desc: "1äººã®éƒ¨å“¡ã®è‹±èªåŠ›ã‚’1å¹´ã§30ä»¥ä¸Šä¸Šã’ã‚‹",
        icon: "ğŸ“ˆ",
        unlocked: false,
        unlockedDate: null
    },
    stress_free: {
        id: "stress_free",
        name: "ã‚¹ãƒˆãƒ¬ã‚¹ãƒ•ãƒªãƒ¼",
        desc: "å…¨å“¡ã®ã‚¹ãƒˆãƒ¬ã‚¹ã‚’0ã«ã™ã‚‹",
        icon: "ğŸ˜Š",
        unlocked: false,
        unlockedDate: null
    },
    elite_team: {
        id: "elite_team",
        name: "ã‚¨ãƒªãƒ¼ãƒˆé›†å›£",
        desc: "å¹³å‡è‹±èªåŠ›ãŒ100ã‚’è¶…ãˆã‚‹",
        icon: "ğŸŒŸ",
        unlocked: false,
        unlockedDate: null
    },
    close_call: {
        id: "close_call",
        name: "å±æ©Ÿä¸€é«ª",
        desc: "ã‚¹ãƒˆãƒ¬ã‚¹90ä»¥ä¸Šã®éƒ¨å“¡ãŒã„ã‚‹çŠ¶æ…‹ã‹ã‚‰ç‡ƒãˆå°½ãå›é¿",
        icon: "âš¡",
        unlocked: false,
        unlockedDate: null
    },
    diversity: {
        id: "diversity",
        name: "å¤šæ§˜æ€§",
        desc: "5ç¨®é¡ä»¥ä¸Šã®ç•°ãªã‚‹ç‰¹æ€§ã‚’æŒã¤éƒ¨å“¡ã‚’é›†ã‚ã‚‹",
        icon: "ğŸŒˆ",
        unlocked: false,
        unlockedDate: null
    },
    legend: {
        id: "legend",
        name: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰",
        desc: "5å¹´ç›®ã«åˆ°é”ã™ã‚‹",
        icon: "ğŸ†",
        unlocked: false,
        unlockedDate: null
    },
    educator: {
        id: "educator",
        name: "æ•™è‚²è€…",
        desc: "ç´¯è¨ˆã§20äººä»¥ä¸Šã®éƒ¨å“¡ã‚’å’æ¥­ã•ã›ã‚‹",
        icon: "ğŸ“š",
        unlocked: false,
        unlockedDate: null
    },
    chaos: {
        id: "chaos",
        name: "ã‚«ã‚ªã‚¹",
        desc: "å…¨å“¡ãŒã‚¹ãƒˆãƒ¬ã‚¹80ä»¥ä¸Šã®çŠ¶æ…‹ã‚’ä½œã‚‹",
        icon: "ğŸ˜±",
        unlocked: false,
        unlockedDate: null
    }
    
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç´¯è¨ˆãƒ‡ãƒ¼ã‚¿ï¼ˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã¯åˆ¥ã«æ°¸ç¶šåŒ–ï¼‰
let globalStats = {
    totalGraduates: 0,
    totalBudgetEarned: 0,
    hasHadHighStress: false, // å±æ©Ÿä¸€é«ªãƒ•ãƒ©ã‚°
    hasHadChaos: false // ã‚«ã‚ªã‚¹ãƒ•ãƒ©ã‚°
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã®èª­ã¿è¾¼ã¿
function loadGlobalStats() {
    const saved = localStorage.getItem('essManagerGlobalStats');
    if (saved) {
        globalStats = JSON.parse(saved);
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±è¨ˆã®ä¿å­˜
function saveGlobalStats() {
    localStorage.setItem('essManagerGlobalStats', JSON.stringify(globalStats));
}

// å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
function loadAchievements() {
    const saved = localStorage.getItem('essManagerAchievements');
    if (saved) {
        const savedData = JSON.parse(saved);
        Object.keys(savedData).forEach(key => {
            if (achievements[key]) {
                achievements[key].unlocked = savedData[key].unlocked;
                achievements[key].unlockedDate = savedData[key].unlockedDate;
            }
        });
    }
    loadGlobalStats();
    updateAchievementCount();
}

// å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
function saveAchievements() {
    localStorage.setItem('essManagerAchievements', JSON.stringify(achievements));
    saveGlobalStats();
}

// éƒ¨å“¡ã®åˆæœŸè‹±èªåŠ›ã‚’è¨˜éŒ²ï¼ˆæ–°æ˜Ÿç™ºæ˜ç”¨ï¼‰
function trackMemberInitialStats() {
    state.members.forEach(m => {
        if (m.initialEng === undefined) {
            m.initialEng = m.eng;
        }
    });
}

// å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
function checkAchievements() {
    // å®Œç’§ãªå¹´åº¦é‹å–¶
    if (!achievements.perfect_year.unlocked && state.week === state.maxWeek) {
        const allLowStress = state.members.every(m => m.stress <= 50);
        if (allLowStress) {
            unlockAchievement('perfect_year');
        }
    }
    
    // è‹±èªãƒã‚¹ã‚¿ãƒ¼
    if (!achievements.english_master.unlocked) {
        const allHighEng = state.members.length > 0 && state.members.every(m => m.eng >= 50);
        if (allHighEng) {
            unlockAchievement('english_master');
        }
    }
    
    
    // çµ¶å¯¾çš„ä¿¡é ¼
    if (!achievements.trust_max.unlocked && state.trust >= 100) {
        unlockAchievement('trust_max');
    }
    
    // å¤§æ‰€å¸¯
    if (!achievements.big_club.unlocked && state.members.length >= 10) {
        unlockAchievement('big_club');
    }
    
    // ç‡ƒãˆå°½ãå›é¿
    if (!achievements.no_burnout.unlocked && state.week === state.maxWeek) {
        const noBurnout = state.members.every(m => !m.burnout);
        if (noBurnout) {
            unlockAchievement('no_burnout');
        }
    }
    
    // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ•ãƒªãƒ¼
    if (!achievements.stress_free.unlocked) {
        const allZeroStress = state.members.length > 0 && state.members.every(m => m.stress === 0);
        if (allZeroStress) {
            unlockAchievement('stress_free');
        }
    }
    
    // ã‚¨ãƒªãƒ¼ãƒˆé›†å›£
    if (!achievements.elite_team.unlocked && state.members.length > 0) {
        const avgEng = state.members.reduce((sum, m) => sum + m.eng, 0) / state.members.length;
        if (avgEng >= 100) {
            unlockAchievement('elite_team');
        }
    }
    
    // å±æ©Ÿä¸€é«ªï¼ˆã‚¹ãƒˆãƒ¬ã‚¹90ä»¥ä¸Šã®éƒ¨å“¡ãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
    const hasHighStress = state.members.some(m => m.stress >= 90);
    if (hasHighStress) {
        globalStats.hasHadHighStress = true;
        saveGlobalStats();
    }
    
    // å±æ©Ÿä¸€é«ªï¼ˆå¹´åº¦çµ‚äº†æ™‚ã«ç‡ƒãˆå°½ãç„¡ã—ã§ã‚¯ãƒªã‚¢ï¼‰
    if (!achievements.close_call.unlocked && state.week === state.maxWeek) {
        const noBurnout = state.members.every(m => !m.burnout);
        if (noBurnout && globalStats.hasHadHighStress) {
            unlockAchievement('close_call');
            globalStats.hasHadHighStress = false; // ãƒªã‚»ãƒƒãƒˆ
            saveGlobalStats();
        }
    }
    
    // å¤šæ§˜æ€§ï¼ˆ5ç¨®é¡ä»¥ä¸Šã®ç•°ãªã‚‹ç‰¹æ€§ï¼‰
    if (!achievements.diversity.unlocked && state.members.length >= 5) {
        const uniqueTraits = new Set(state.members.map(m => m.trait));
        if (uniqueTraits.size >= 5) {
            unlockAchievement('diversity');
        }
    }
   
    
    // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ï¼ˆ5å¹´ç›®åˆ°é”ï¼‰
    if (!achievements.legend.unlocked && state.year >= 5) {
        unlockAchievement('legend');
    }
    
    // æ•™è‚²è€…ï¼ˆç´¯è¨ˆ20äººä»¥ä¸Šå’æ¥­ï¼‰
    if (!achievements.educator.unlocked && globalStats.totalGraduates >= 20) {
        unlockAchievement('educator');
    }
    

    // ã‚«ã‚ªã‚¹ï¼ˆå…¨å“¡ãŒã‚¹ãƒˆãƒ¬ã‚¹80ä»¥ä¸Šï¼‰
    if (!achievements.chaos.unlocked && state.members.length > 0) {
        const allHighStress = state.members.every(m => m.stress >= 80);
        if (allHighStress && !globalStats.hasHadChaos) {
            unlockAchievement('chaos');
            globalStats.hasHadChaos = true;
            saveGlobalStats();
        }
    }
}

// å®Ÿç¸¾è§£é™¤
function unlockAchievement(id) {
    if (!achievements[id] || achievements[id].unlocked) return;
    
    achievements[id].unlocked = true;
    achievements[id].unlockedDate = new Date().toISOString();
    saveAchievements();
    updateAchievementCount();
    
    // é€šçŸ¥è¡¨ç¤º
    const notification = document.getElementById('achievement-notification');
    notification.querySelector('.notification-desc').textContent = achievements[id].name;
    notification.classList.remove('hidden');
    
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 4000);
}

// å®Ÿç¸¾ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
function updateAchievementCount() {
    const total = Object.keys(achievements).length;
    const unlocked = Object.values(achievements).filter(a => a.unlocked).length;
    const badge = document.getElementById('achievement-count');
    if (badge) {
        badge.textContent = `${unlocked}/${total}`;
    }
}

// å®Ÿç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showAchievementModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">ğŸ† å®Ÿç¸¾ä¸€è¦§</h2>
            <div class="achievement-grid" id="achievement-grid"></div>
            <button onclick="this.closest('.modal').remove()" class="btn-next" style="margin-top: 20px;">é–‰ã˜ã‚‹</button>
        </div>
    `;
    document.body.appendChild(modal);
    
    const grid = document.getElementById('achievement-grid');
    
    Object.values(achievements).forEach(ach => {
        const card = document.createElement('div');
        card.className = `achievement-card ${ach.unlocked ? 'unlocked' : 'locked'}`;
        
        let dateStr = '';
        if (ach.unlocked && ach.unlockedDate) {
            const date = new Date(ach.unlockedDate);
            dateStr = `<div class="achievement-date">è§£é™¤æ—¥: ${date.toLocaleDateString()}</div>`;
        }
        
        card.innerHTML = `
            <div class="achievement-icon">${ach.icon}</div>
            <div class="achievement-name">${ach.name}</div>
            <div class="achievement-desc">${ach.desc}</div>
            ${dateStr}
        `;
        grid.appendChild(card);
    });
}

// å’æ¥­å‡¦ç†æ™‚ã«å‘¼ã³å‡ºã™é–¢æ•°ï¼ˆendYearé–¢æ•°å†…ã§ä½¿ç”¨ï¼‰
function updateGraduationStats(graduatingCount) {
    globalStats.totalGraduates += graduatingCount;
    saveGlobalStats();
}

// éƒ¨è²»ç²å¾—æ™‚ã«å‘¼ã³å‡ºã™é–¢æ•°ï¼ˆexecuteActionã€ã‚³ãƒ³ãƒ†ã‚¹ãƒˆå ±é…¬ãªã©ã§ä½¿ç”¨ï¼‰
function updateBudgetStats(amount) {
    if (amount > 0) {
        globalStats.totalBudgetEarned += amount;
        saveGlobalStats();
    }
}


// ============================================
// 3. ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
// ============================================

const randomEvents = [
    {
        id: "festival_prep",
        name: "å­¦åœ’ç¥­æº–å‚™ã®ä¾é ¼",
        desc: "ç”Ÿå¾’ä¼šã‹ã‚‰ã€Œè‹±èªã§ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼ã€ã¨é ¼ã¾ã‚Œã¾ã—ãŸã€‚",
        icon: "ğŸª",
        type: "neutral",
        chance: 0.15,
        effects: {
            stress: 20,
            trust: 15
        },
        message: "ã‚¹ãƒˆãƒ¬ã‚¹+20ã€ä¿¡é ¼åº¦+15"
    },
    {
        id: "teacher_gift",
        name: "å…ˆç”Ÿã®å·®ã—å…¥ã‚Œ",
        desc: "å¹³é‡å…ˆç”ŸãŒã€ŒãŸã¾ã«ã¯ä¼‘ã‚ã€ã¨ãŠè“å­ã‚’å·®ã—å…¥ã‚Œã¦ãã‚Œã¾ã—ãŸã€‚",
        icon: "ğŸ°",
        type: "positive",
        chance: 0.12,
        effects: {
            stress: -10
        },
        message: "å…¨å“¡ã®ã‚¹ãƒˆãƒ¬ã‚¹-10"
    },
    {
        id: "flu_outbreak",
        name: "ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶æµè¡Œ",
        desc: "å­¦æ ¡ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶ãŒæµè¡Œä¸­ã€‚ãƒ©ãƒ³ãƒ€ãƒ ãªéƒ¨å“¡ãŒ1é€±é–“ä¼‘ã‚€ã“ã¨ã«â€¦",
        icon: "ğŸ¤’",
        type: "negative",
        chance: 0.1,
        effects: {
            absentee: 1
        },
        message: "1åãŒæ¬ å¸­"
    },
    {
        id: "english_camp",
        name: "è‹±èªã‚­ãƒ£ãƒ³ãƒ—ã®èª˜ã„",
        desc: "è¿‘éš£æ ¡ã¨åˆåŒã§è‹±èªã‚­ãƒ£ãƒ³ãƒ—ã‚’é–‹å‚¬ã™ã‚‹ã¨ã®ã“ã¨ã€‚",
        icon: "ğŸ•ï¸",
        type: "positive",
        chance: 0.08,
        effects: {
            eng: 8,
            stress: 15,
            budget: -300
        },
        message: "è‹±èªåŠ›+8ã€ã‚¹ãƒˆãƒ¬ã‚¹+15ã€éƒ¨è²»-Â¥300"
    },
    {
        id: "equipment_broken",
        name: "æ©Ÿæã®æ•…éšœ",
        desc: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚¿ãƒ¼ãŒæ•…éšœã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ä¿®ç†ãŒå¿…è¦ã§ã™ã€‚",
        icon: "ğŸ’”",
        type: "negative",
        chance: 0.1,
        effects: {
            budget: -1400
        },
        message: "éƒ¨è²»-Â¥1400"
    },
    {
        id: "alumni_visit",
        name: "OBãƒ»OGã®è¨ªå•",
        desc: "å’æ¥­ç”ŸãŒè¨ªã­ã¦ãã¦ã€åŠ±ã¾ã—ã®è¨€è‘‰ã¨ãŠé‡‘ã‚’ãã‚Œã¾ã—ãŸï¼",
        icon: "ğŸ‘‹",
        type: "positive",
        chance: 0.1,
        effects: {
            budget: 600,
            trust: 5
        },
        message: "éƒ¨è²»+Â¥600ã€ä¿¡é ¼åº¦+5"
    },
    {
        id: "rainy_week",
        name: "é€£æ—¥ã®é›¨",
        desc: "1é€±é–“ãšã£ã¨é›¨ã§æ°—åˆ†ãŒæ™´ã‚Œã¾ã›ã‚“â€¦ã¿ã‚“ãªã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸‹ãŒã£ã¦ã„ã¾ã™ã€‚",
        icon: "ğŸŒ§ï¸",
        type: "negative",
        chance: 0.1,
        effects: {
            stress: 10,
            trust: -5
        },
        message: "ã‚¹ãƒˆãƒ¬ã‚¹+10ã€ä¿¡é ¼åº¦-5"
    },
    {
        id: "motivational_speaker",
        name: "ç‰¹åˆ¥è¬›å¸«ã®è¨ªå•",
        desc: "ãƒ—ãƒ­ã®é€šè¨³è€…ãŒç‰¹åˆ¥è¬›ç¾©ã‚’ã—ã¦ãã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸï¼",
        icon: "ğŸ¤",
        type: "positive",
        chance: 0.08,
        effects: {
            eng: 5,
            trust: 5
        },
        message: "è‹±èªåŠ›+5ã€ä¿¡é ¼åº¦+5"
    }
];

// ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆæŠ½é¸
function checkRandomEvent() {
    // 20%ã®ç¢ºç‡ã§ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š
    if (Math.random() > 0.2) return null;
    
    const availableEvents = randomEvents.filter(e => Math.random() < e.chance);
    if (availableEvents.length === 0) return null;
    
    return availableEvents[Math.floor(Math.random() * availableEvents.length)];
}

// ã‚¤ãƒ™ãƒ³ãƒˆå®Ÿè¡Œ
function triggerRandomEvent(event) {
    const modal = document.createElement('div');
    modal.className = 'modal event-card-modal';
    modal.innerHTML = `
        <div class="modal-content event-card ${event.type}">
            <div class="event-icon">${event.icon}</div>
            <div class="event-title">${event.name}</div>
            <div class="event-description">${event.desc}</div>
            <div class="event-effects">
                <div class="event-effect-item">
                    <span>åŠ¹æœ:</span>
                    <span class="${event.type === 'positive' ? 'event-effect-positive' : event.type === 'negative' ? 'event-effect-negative' : ''}">${event.message}</span>
                </div>
            </div>
            <button onclick="applyEventEffects(this, ${JSON.stringify(event).replace(/"/g, '&quot;')})" class="btn-next">äº†è§£</button>
        </div>
    `;
    document.body.appendChild(modal);
}

// ã‚¤ãƒ™ãƒ³ãƒˆåŠ¹æœé©ç”¨
function applyEventEffects(button, event) {
    const effects = event.effects;
    
    state.members.forEach(m => {
        if (effects.stress) m.stress = Math.max(0, Math.min(100, m.stress + effects.stress));
        if (effects.eng && !m.burnout) {
            const growth = Math.floor(effects.eng * m.growthRate);
            m.eng = Math.min(200, m.eng + growth);
        }
    });
    
    if (effects.trust) state.trust = Math.max(0, state.trust + effects.trust);
    if (effects.budget) state.budget += effects.budget;
    
    if (effects.absentee) {
        const availableMembers = state.members.filter(m => !m.burnout);
        if (availableMembers.length > 0) {
            const absentee = availableMembers[Math.floor(Math.random() * availableMembers.length)];
            absentee.stress += 10; // æ¬ å¸­ã«ã‚ˆã‚‹ã‚¹ãƒˆãƒ¬ã‚¹
        }
    }
    
    button.closest('.modal').remove();
    updateUI();
}

// ============================================
// æ—¢å­˜é–¢æ•°ã¸ã®çµ±åˆ
// ============================================

// initGameé–¢æ•°ã«è¿½åŠ 
const originalInitGame = window.initGame;
window.initGame = function() {
    loadAchievements();
    if (originalInitGame) originalInitGame();
};

// loadWeeké–¢æ•°ã«è¿½åŠ ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼‰
const originalLoadWeek = window.loadWeek;
window.loadWeek = function() {
    if (originalLoadWeek) originalLoadWeek();
    
    // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆç¬¬1é€±ã¨æœ€çµ‚é€±ä»¥å¤–ï¼‰
    if (state.week > 1 && state.week < state.maxWeek) {
        const event = checkRandomEvent();
        if (event) {
            setTimeout(() => triggerRandomEvent(event), 500);
        }
    }
    
    // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
    checkAchievements();
};

// updateUIé–¢æ•°ã«å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
const originalUpdateUI = window.updateUI;
window.updateUI = function() {
    if (originalUpdateUI) originalUpdateUI();
    checkAchievements();
};
    
    
    
</script>
</body>
</html>